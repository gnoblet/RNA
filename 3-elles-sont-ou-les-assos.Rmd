# Chapitre 3 : Elles sont où les assos ? ou Répresentations géographiques (#geographie)

On a vu dans les données que pour chaque association on a le code INSEE sous la variable "adrs_codeinsee". Le code INSEE, c'est un peu comme le code postal, autrement dit un identifiant unique pour chaque commune, mais délivré par l'INSEE. 

## Crééer la variable de département

On aimerait représenter le nombre d'associations par département. Pour l'instant, le code INSEE ne nous permet que d'identifier la commune. Cependant, les deux premiers chiffres du code INSEE sont en fait le code du département. Il nous suffit donc de subdiviser le code INSEE à chaque ligne en ne gardant que les premiers chiffres. On créé une variable qui s'intitutle "codeDept".


```{r}
asso01$codeDept <- substr(asso01$adrs_codeinsee, 1,2)
```


## Cartes de l'IGN

Il va falloir maintenant récupérer les données nous permettant de représenter la carte de France des départements, puis le nombre d'assos par département. On ne va pas entrer dans les détails des données géographiques ici.

On peut se procurer les fichiers ici : <https://wxs.ign.fr/oikr5jryiph0iwhw36053ptm/telechargement/inspire/GEOFLA_THEME-DEPARTEMENTS_2016%24GEOFLA_2-2_DEPARTEMENT_SHP_LAMB>93_FXX_2016-06-28/file/GEOFLA_2-2_DEPARTEMENT_SHP_LAMB93_FXX_2016-06-28.7z>

En extrayant le fichier on voit qu'il existe une multitude de fichiers différents. [Expliciter le chemin et l'extraction]

require(sf)

```{r}
require(sf) # Package nécessaire pour l'ouverture d'un fichier géographique "shp" 
# Créer un objet contenant les données géographiques du départements
sf_dept <- st_read("Data/GEOFLA/DEPARTEMENT.shp", stringsAsFactors = FALSE) 
colnames(sf_dept) # Afficher les noms des variables
```
On voit que dans le *dataframe*, on a le le code du département "CODE_DEPT", ce qui va nous permettre de joindre les données géographiques et les données des associations. Les variables "X_CENTROID" et "Y_CENTROID" donnent les coordonnées du centroid [dire plus] du département et "X_CHF_LIEU" et "Y_CHF_LIEU" celles du chef-lieu de département. La variable la plus important est la dernière "geometry' qui contient une liste de polygones représentant le contour des départements.

On peut déjà noter qu'il existe deux types de format de données géographiques dans R (au moins deux qu'on va utiliser en tout cas). Le fichier "sf" ci-dessus en est un. Il en existe un autre qui s'intutile "Spatial Polygons Dataframes". La fonction **sf::as_spatial** permet d'obtenir le deuxième type à partir du premier.
```{r}
sp_dept <- as_Spatial(sf_dept)
```

## Joindre données géographgique et d'associations

On peut commencer par compter le nombre d'associations par départements
```{r}
require(dplyr) # Pour transformer les données, notamment joindre deux dataframes
nbasso_dept <- asso01%>%
  count(codeDept)
```


```{r}
# Joindre les deux dataframes
colnames(sf_dept)[2] <- "codeDept"
sf_dept <- sf_dept %>%
  left_join(nbasso_dept)
```

Faire une première carte
```{r}
require(tmap)
map_nbasso_dept <- tm_shape(sf_dept) +
  tm_fill(n)
```

